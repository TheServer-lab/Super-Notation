<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Notation Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .input-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-section:last-child {
            margin-bottom: 0;
        }

        .input-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        input[type="file"] {
            display: none;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .divider {
            text-align: center;
            margin: 25px 0;
            color: #999;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .document-panel {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-height: 400px;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .status-message.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .status-message.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        /* Rendered SN Content Styles */
        .sn-content {
            line-height: 1.8;
        }

        .sn-title {
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .sn-section {
            color: #34495e;
            margin-top: 2.5em;
            margin-bottom: 1em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 1.8em;
        }

        .sn-para {
            margin: 1.2em 0;
            color: #333;
            font-size: 1.05em;
        }

        .sn-break {
            margin: 2.5em 0;
            border: none;
            border-top: 2px solid #bdc3c7;
        }

        .sn-list {
            margin: 1.2em 0;
            padding-left: 2.5em;
        }

        .sn-list li {
            margin: 0.7em 0;
            color: #333;
        }

        .sn-code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
            margin: 1.5em 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sn-code code {
            background: none;
            color: inherit;
        }

        .sn-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1.5em 0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sn-link, .sn-opensn {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .sn-link:hover, .sn-opensn:hover {
            text-decoration: underline;
        }

        .sn-next {
            margin-top: 3em;
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid #667eea;
            border-radius: 8px;
        }

        .sn-next a {
            color: #2c3e50;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
        }

        .sn-seal {
            margin-top: 3em;
            padding: 20px;
            background: linear-gradient(135deg, #d5f4e6 0%, #c8e6c9 100%);
            border: 2px solid #27ae60;
            border-radius: 8px;
            text-align: center;
            color: #27ae60;
            font-weight: bold;
            font-size: 1.1em;
        }

        .sn-unknown {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 1em 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .metadata-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .metadata-panel h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .metadata-item {
            color: #666;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2em;
        }

        .loading::before {
            content: "‚è≥";
            font-size: 3em;
            display: block;
            margin-bottom: 15px;
        }

        .welcome {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .welcome::before {
            content: "üìñ";
            font-size: 4em;
            display: block;
            margin-bottom: 20px;
        }

        .welcome h2 {
            color: #666;
            margin-bottom: 15px;
        }

        .welcome p {
            font-size: 1.1em;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .input-panel,
            .document-panel {
                padding: 20px;
            }

            .url-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Super Notation Browser</h1>
            <p>View and read Super Notation (SN v1.0) documents in your browser</p>
        </div>

        <div class="input-panel">
            <div class="input-section">
                <h3>üìÑ Upload SN File</h3>
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-input-label">
                        <span>üìÅ</span>
                        <span id="fileLabel">Choose File</span>
                    </label>
                    <input type="file" id="fileInput" accept=".sn,text/plain">
                </div>
            </div>

            <div class="divider">OR</div>

            <div class="input-section">
                <h3>üîó Load from URL</h3>
                <div class="url-input-group">
                    <input type="text" id="urlInput" placeholder="https://example.com/document.sn">
                    <button onclick="loadFromUrl()">Load</button>
                </div>
            </div>
        </div>

        <div class="document-panel" id="documentPanel">
            <div class="welcome">
                <h2>Welcome to Super Notation Browser</h2>
                <p>Upload a .sn file or load from a URL to view your documentation.</p>
            </div>
        </div>
    </div>

    <script>
        // Simple SN Parser
        function parseSN(content) {
            const lines = content.split('\n');
            const nodes = [];
            const metadata = [];
            let i = 0;
            let inCodeBlock = false;
            let codeContent = [];
            let inList = false;
            let listItems = [];
            let listType = 'bullet';

            // Skip to declaration
            while (i < lines.length && !lines[i].trim().match(/^<super-notation-v1>/i)) {
                i++;
            }
            i++; // Skip declaration line

            while (i < lines.length) {
                const line = lines[i];
                const trimmed = line.trim();

                // Handle code block
                if (inCodeBlock) {
                    if (trimmed.toLowerCase() === 'endcode:') {
                        nodes.push({ type: 'code', code: codeContent.join('\n') });
                        codeContent = [];
                        inCodeBlock = false;
                    } else {
                        codeContent.push(line);
                    }
                    i++;
                    continue;
                }

                // Start code block
                if (trimmed.toLowerCase() === 'code:') {
                    if (inList) {
                        nodes.push({ type: 'list', listType, items: [...listItems] });
                        listItems = [];
                        inList = false;
                    }
                    inCodeBlock = true;
                    i++;
                    continue;
                }

                // Handle list end
                if (inList && (trimmed === '' || trimmed.match(/^[a-z]+:/i))) {
                    nodes.push({ type: 'list', listType, items: [...listItems] });
                    listItems = [];
                    inList = false;
                }

                // Comments and blank lines
                if (trimmed.startsWith('#') || trimmed === '') {
                    i++;
                    continue;
                }

                // Metadata
                if (trimmed.toLowerCase().startsWith('meta:')) {
                    metadata.push(trimmed.substring(5).trim());
                    i++;
                    continue;
                }

                // Title
                if (trimmed.toLowerCase().startsWith('title:')) {
                    nodes.push({ type: 'title', text: trimmed.substring(6).trim() });
                    i++;
                    continue;
                }

                // Section
                if (trimmed.toLowerCase().startsWith('sec:') && !trimmed.includes('=')) {
                    const id = trimmed.substring(4).trim();
                    nodes.push({ type: 'section', id });
                    i++;
                    continue;
                }

                // Section link
                if (trimmed.match(/^sec=/i)) {
                    const match = trimmed.match(/^sec=([^:]+):\s*(.+)$/i);
                    if (match) {
                        nodes.push({ type: 'section-link', id: match[1], text: match[2] });
                    }
                    i++;
                    continue;
                }

                // Paragraph
                if (trimmed.toLowerCase().startsWith('para:')) {
                    nodes.push({ type: 'para', text: trimmed.substring(5).trim() });
                    i++;
                    continue;
                }

                // Break
                if (trimmed.toLowerCase().match(/^break-line/)) {
                    nodes.push({ type: 'break' });
                    i++;
                    continue;
                }

                // List start
                if (trimmed.toLowerCase().match(/^olist:(bullet|numbers)/)) {
                    inList = true;
                    listType = trimmed.toLowerCase().includes('numbers') ? 'numbers' : 'bullet';
                    i++;
                    continue;
                }

                // List items
                if (inList && trimmed !== '') {
                    listItems.push(trimmed);
                    i++;
                    continue;
                }

                // Image
                if (trimmed.toLowerCase().startsWith('img:=')) {
                    const content = trimmed.substring(5).trim();
                    const parts = content.split('|');
                    nodes.push({ 
                        type: 'image', 
                        path: parts[0].trim(), 
                        alt: parts[1] ? parts[1].trim() : '' 
                    });
                    i++;
                    continue;
                }

                // Link
                if (trimmed.toLowerCase().startsWith('link:')) {
                    nodes.push({ type: 'link', url: trimmed.substring(5).trim() });
                    i++;
                    continue;
                }

                // Link with text
                if (trimmed.toLowerCase().startsWith('linktxt:')) {
                    const content = trimmed.substring(8).trim();
                    const parts = content.includes('|') ? content.split('|') : content.split(':');
                    if (parts.length >= 2) {
                        nodes.push({ 
                            type: 'linktext', 
                            text: parts[0].trim(), 
                            url: parts[1].trim() 
                        });
                    }
                    i++;
                    continue;
                }

                // Open SN
                if (trimmed.match(/^opensn=/i)) {
                    const match = trimmed.match(/^opensn=([^:]+):\s*(.+)$/i);
                    if (match) {
                        nodes.push({ 
                            type: 'opensn', 
                            location: match[1].trim(), 
                            text: match[2].trim() 
                        });
                    }
                    i++;
                    continue;
                }

                // End new SN
                if (trimmed.toLowerCase().startsWith('endnewsn:')) {
                    nodes.push({ 
                        type: 'endnewsn', 
                        filepath: trimmed.substring(9).trim() 
                    });
                    i++;
                    continue;
                }

                // Sign
                if (trimmed.toLowerCase().startsWith('sign:')) {
                    nodes.push({ type: 'signature', sig: trimmed.substring(5).trim() });
                    i++;
                    continue;
                }

                // Background color
                if (trimmed.toLowerCase().startsWith('bgcolor:')) {
                    nodes.push({ 
                        type: 'bgcolor', 
                        color: trimmed.substring(8).trim() 
                    });
                    i++;
                    continue;
                }

                // Text color
                if (trimmed.toLowerCase().startsWith('txtcolor:')) {
                    nodes.push({ 
                        type: 'txtcolor', 
                        color: trimmed.substring(9).trim() 
                    });
                    i++;
                    continue;
                }

                // Close
                if (trimmed.toLowerCase() === 'close:') {
                    nodes.push({ type: 'close' });
                    i++;
                    continue;
                }

                i++;
            }

            // Handle any remaining list
            if (inList && listItems.length > 0) {
                nodes.push({ type: 'list', listType, items: listItems });
            }

            return { metadata, nodes };
        }

        // Format inline text
        function formatInline(text) {
            let result = escapeHtml(text);

            // Handle escaped braces
            result = result.replace(/\{\{/g, '\x00LB\x00');
            result = result.replace(/\}\}/g, '\x00RB\x00');

            // Bold
            result = result.replace(/\{b:(.*?)\}/gi, '<strong>$1</strong>');
            result = result.replace(/\{bold:(.*?)\}/gi, '<strong>$1</strong>');

            // Italic
            result = result.replace(/\{i:(.*?)\}/gi, '<em>$1</em>');
            result = result.replace(/\{italic:(.*?)\}/gi, '<em>$1</em>');

            // Underline
            result = result.replace(/\{u:(.*?)\}/gi, '<u>$1</u>');

            // Color
            result = result.replace(/\{color=([^:]+):(.*?)\}/gi, (match, color, text) => {
                return `<span style="color: ${escapeHtml(color)}">${text}</span>`;
            });

            // Restore escaped braces
            result = result.replace(/\x00LB\x00/g, '{');
            result = result.replace(/\x00RB\x00/g, '}');

            return result;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Render to HTML
        function renderSN(doc) {
            let html = '';

            // Metadata
            if (doc.metadata.length > 0) {
                html += '<div class="metadata-panel">';
                html += '<h4>üìã Document Metadata</h4>';
                doc.metadata.forEach(meta => {
                    html += `<div class="metadata-item">${escapeHtml(meta)}</div>`;
                });
                html += '</div>';
            }

            html += '<div class="sn-content">';

            let hasSignature = false;
            let isClosed = false;
            let currentBgColor = null;
            let currentTxtColor = null;

            doc.nodes.forEach(node => {
                let nodeHtml = '';
                let style = '';
                
                // Apply current colors if set
                if (currentBgColor || currentTxtColor) {
                    style = 'style="';
                    if (currentBgColor) style += `background-color: ${currentBgColor};`;
                    if (currentTxtColor) style += `color: ${currentTxtColor};`;
                    style += ' padding: 15px; border-radius: 8px; margin: 10px 0;"';
                }

                switch (node.type) {
                    case 'bgcolor':
                        currentBgColor = node.color;
                        return; // Don't add HTML for this node

                    case 'txtcolor':
                        currentTxtColor = node.color;
                        return; // Don't add HTML for this node

                    case 'title':
                        nodeHtml = `<h1 class="sn-title" ${style}>${formatInline(node.text)}</h1>`;
                        break;

                    case 'section':
                        nodeHtml = `<h2 id="${escapeHtml(node.id)}" class="sn-section" ${style}>${escapeHtml(node.id.replace(/-/g, ' ').replace(/_/g, ' '))}</h2>`;
                        break;

                    case 'section-link':
                        nodeHtml = `<p ${style}><a href="#${escapeHtml(node.id)}">${formatInline(node.text)}</a></p>`;
                        break;

                    case 'para':
                        nodeHtml = `<p class="sn-para" ${style}>${formatInline(node.text)}</p>`;
                        break;

                    case 'break':
                        nodeHtml = '<hr class="sn-break">';
                        // Reset colors after break
                        currentBgColor = null;
                        currentTxtColor = null;
                        break;

                    case 'list':
                        const tag = node.listType === 'numbers' ? 'ol' : 'ul';
                        nodeHtml = `<${tag} class="sn-list" ${style}>`;
                        node.items.forEach(item => {
                            nodeHtml += `<li>${formatInline(item)}</li>`;
                        });
                        nodeHtml += `</${tag}>`;
                        break;

                    case 'code':
                        nodeHtml = `<pre class="sn-code" ${style}><code>${escapeHtml(node.code)}</code></pre>`;
                        break;

                    case 'image':
                        nodeHtml = `<img src="${escapeHtml(node.path)}" alt="${escapeHtml(node.alt)}" class="sn-image">`;
                        break;

                    case 'link':
                        nodeHtml = `<p ${style}><a href="${escapeHtml(node.url)}" class="sn-link" target="_blank">${escapeHtml(node.url)}</a></p>`;
                        break;

                    case 'linktext':
                        nodeHtml = `<p ${style}><a href="${escapeHtml(node.url)}" class="sn-link" target="_blank">${formatInline(node.text)}</a></p>`;
                        break;

                    case 'opensn':
                        nodeHtml = `<p ${style}><a href="${escapeHtml(node.location)}" class="sn-opensn">${formatInline(node.text)}</a></p>`;
                        break;

                    case 'endnewsn':
                        nodeHtml = `<div class="sn-next"><a href="${escapeHtml(node.filepath)}">Next: ${escapeHtml(node.filepath)} ‚Üí</a></div>`;
                        break;

                    case 'signature':
                        hasSignature = true;
                        break;

                    case 'close':
                        isClosed = true;
                        break;
                }

                html += nodeHtml;
            });

            html += '</div>';

            // Seal indicator
            if (hasSignature && isClosed) {
                html += '<div class="sn-seal">üîí Document sealed and signed</div>';
            }

            return html;
        }

        // UI Functions
        function showStatus(message, type = 'info') {
            const panel = document.getElementById('documentPanel');
            panel.innerHTML = `<div class="status-message ${type}">${message}</div>`;
        }

        function showLoading() {
            const panel = document.getElementById('documentPanel');
            panel.innerHTML = '<div class="loading">Loading document...</div>';
        }

        function renderDocument(content) {
            try {
                showLoading();

                setTimeout(() => {
                    try {
                        const doc = parseSN(content);
                        const html = renderSN(doc);

                        const panel = document.getElementById('documentPanel');
                        panel.innerHTML = html;

                        // Smooth scroll to top
                        panel.scrollIntoView({ behavior: 'smooth' });
                    } catch (error) {
                        showStatus(`<strong>Parse Error:</strong> ${error.message}`, 'error');
                    }
                }, 100);

            } catch (error) {
                showStatus(`<strong>Error:</strong> ${error.message}`, 'error');
            }
        }

        // File upload handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const label = document.getElementById('fileLabel');
            label.textContent = file.name;

            if (!file.name.endsWith('.sn')) {
                showStatus('<strong>Warning:</strong> Selected file does not have .sn extension. It may not be a valid Super Notation file.', 'warning');
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                renderDocument(e.target.result);
            };
            reader.onerror = function() {
                showStatus('<strong>Error:</strong> Failed to read file.', 'error');
            };
            reader.readAsText(file);
        });

        // URL loading
        async function loadFromUrl() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();

            if (!url) {
                showStatus('<strong>Error:</strong> Please enter a URL.', 'error');
                return;
            }

            try {
                showLoading();

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const content = await response.text();
                renderDocument(content);

            } catch (error) {
                showStatus(`<strong>Error loading URL:</strong> ${error.message}<br><br>Note: Due to CORS restrictions, you may only be able to load files from the same domain or servers that allow cross-origin requests.`, 'error');
            }
        }

        // Allow Enter key to load URL
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadFromUrl();
            }
        });
    </script>
</body>
</html>
